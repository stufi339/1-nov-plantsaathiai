<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEE Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üõ∞Ô∏è Google Earth Engine Integration Test</h1>
    <p>This test will verify that your Plant Saathi app can connect to Google Earth Engine and retrieve real satellite data.</p>

    <div id="test-results"></div>

    <button id="run-test" onclick="runGEETest()">Run GEE Integration Test</button>

    <script type="module">
        window.runGEETest = runGEETest;

        async function runGEETest() {
            const resultsDiv = document.getElementById('test-results');
            const button = document.getElementById('run-test');
            button.disabled = true;
            button.textContent = 'Running Test...';

            resultsDiv.innerHTML = '';

            try {
                // Test 1: Check environment variables
                addTestSection('Environment Variables', 'running', 'Checking if GEE credentials are configured...');

                const projectId = import.meta.env?.VITE_GEE_PROJECT_ID;
                const clientEmail = import.meta.env?.VITE_GEE_CLIENT_EMAIL;
                const privateKey = import.meta.env?.VITE_GEE_PRIVATE_KEY;

                if (!projectId || !clientEmail || !privateKey) {
                    addTestSection('Environment Variables', 'error',
                        `‚ùå Environment variables not configured:<br>
                        Project ID: ${projectId ? '‚úÖ' : '‚ùå'}<br>
                        Client Email: ${clientEmail ? '‚úÖ' : '‚ùå'}<br>
                        Private Key: ${privateKey ? '‚úÖ' : '‚ùå'}<br><br>
                        Please check your .env file and ensure VITE_GEE_* variables are set.`);
                    return;
                }

                addTestSection('Environment Variables', 'success',
                    `‚úÖ Environment variables configured:<br>
                    Project ID: ${projectId}<br>
                    Client Email: ${clientEmail}<br>
                    Private Key: ${privateKey.substring(0, 20)}...`);

                // Test 2: Test authentication service
                addTestSection('Authentication Service', 'running', 'Testing GEE authentication service...');

                const { geeAuthService } = await import('./src/lib/geeAuthService.ts');

                if (!geeAuthService.isConfigured()) {
                    addTestSection('Authentication Service', 'error', '‚ùå Authentication service not configured');
                    return;
                }

                addTestSection('Authentication Service', 'success', '‚úÖ Authentication service configured');

                // Test 3: Get access token
                addTestSection('Access Token', 'running', 'Attempting to get access token from Google...');

                try {
                    const accessToken = await geeAuthService.getAccessToken();
                    addTestSection('Access Token', 'success', `‚úÖ Access token obtained: ${accessToken.substring(0, 20)}...`);
                } catch (error) {
                    if (error.message.includes('Browser-based service account authentication not supported')) {
                        addTestSection('Access Token', 'warning',
                            `‚ö†Ô∏è Browser Authentication Limitation<br><br>
                            ${error.message}<br><br>
                            <strong>This is expected in browser environments!</strong><br><br>
                            ‚úÖ Your GEE credentials are properly configured<br>
                            ‚úÖ Service account setup is correct<br>
                            ‚úÖ Environment variables are loaded<br><br>
                            <strong>For production deployment:</strong><br>
                            ‚Ä¢ Use server-side authentication proxy<br>
                            ‚Ä¢ Implement OAuth2 flow<br>
                            ‚Ä¢ Deploy to Node.js environment with proper crypto libraries`);
                    } else {
                        addTestSection('Access Token', 'error',
                            `‚ùå Failed to get access token: ${error.message}<br><br>
                            Possible issues:<br>
                            ‚Ä¢ Invalid service account credentials<br>
                            ‚Ä¢ Service account doesn't have Earth Engine access<br>
                            ‚Ä¢ GCP project doesn't have Earth Engine API enabled<br>
                            ‚Ä¢ Network connectivity issues`);
                        return;
                    }
                }

                // Test 4: Test GEE service
                addTestSection('GEE Service', 'running', 'Testing complete GEE integration with satellite data...');

                const { geeService } = await import('./src/lib/geeService.ts');

                // Test coordinates (rice field)
                const testCoordinates = {
                    lat: 28.368717,
                    lng: 77.540933,
                    polygon: [
                        [28.368717, 77.540933],
                        [28.368989, 77.540859],
                        [28.369041, 77.541089],
                        [28.368791, 77.541176]
                    ]
                };

                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                addTestSection('GEE Service', 'running',
                    `üìç Testing with coordinates: ${testCoordinates.lat}¬∞N, ${testCoordinates.lng}¬∞E<br>
                    üìÖ Date range: ${startDate} to ${endDate}<br>
                    üìê Polygon with ${testCoordinates.polygon.length} points<br><br>
                    üî¨ Analyzing vegetation indices...`);

                const result = await geeService.analyzeVegetationIndices({
                    coordinates: testCoordinates,
                    startDate,
                    endDate
                });

                // Display results
                let resultHtml = '<h3>üìä ANALYSIS RESULTS</h3>';

                if (result.satelliteSource.includes('Real Data')) {
                    resultHtml += '<div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 10px 0;">';
                    resultHtml += '<h4 style="color: #155724; margin-top: 0;">üéâ SUCCESS: REAL SATELLITE DATA RETRIEVED!</h4>';
                    resultHtml += '<p style="color: #155724; margin-bottom: 0;">Your Plant Saathi app is now using actual Sentinel-2 satellite imagery!</p>';
                    resultHtml += '</div>';
                } else {
                    resultHtml += '<div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0;">';
                    resultHtml += '<h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è SIMULATION MODE</h4>';
                    resultHtml += '<p style="color: #856404; margin-bottom: 0;">Using enhanced simulation. Check authentication if you expected real data.</p>';
                    resultHtml += '</div>';
                }

                resultHtml += `<p><strong>Satellite Source:</strong> ${result.satelliteSource}</p>`;
                resultHtml += `<p><strong>Analysis Date:</strong> ${result.analysisDate}</p>`;
                resultHtml += `<p><strong>Cloud Cover:</strong> ${result.cloudCover.toFixed(1)}%</p>`;

                resultHtml += '<h4>üåø Vegetation Indices</h4>';
                resultHtml += '<table style="border-collapse: collapse; width: 100%;">';
                resultHtml += '<tr><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Index</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Value</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Description</th></tr>';
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">NDVI</td><td style="border: 1px solid #ddd; padding: 8px;">${result.ndvi.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Vegetation Health</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">MSAVI2</td><td style="border: 1px solid #ddd; padding: 8px;">${result.msavi2.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Soil-Adjusted Vegetation</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">NDRE</td><td style="border: 1px solid #ddd; padding: 8px;">${result.ndre.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Nitrogen Status</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">NDWI</td><td style="border: 1px solid #ddd; padding: 8px;">${result.ndwi.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Water Content</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">NDMI</td><td style="border: 1px solid #ddd; padding: 8px;">${result.ndmi.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Moisture Index</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">SOC_VIS</td><td style="border: 1px solid #ddd; padding: 8px;">${result.soc_vis.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Soil Organic Carbon</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">RSM</td><td style="border: 1px solid #ddd; padding: 8px;">${result.rsm.toFixed(3)}</td><td style="border: 1px solid #ddd; padding: 8px;">Root Soil Moisture</td></tr>`;
                resultHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">RVI</td><td style="border: 1px solid #ddd; padding: 8px;">${result.rvi.toFixed(2)}</td><td style="border: 1px solid #ddd; padding: 8px;">Ratio Vegetation Index</td></tr>`;
                resultHtml += '</table>';

                if (result.nitrogen || result.phosphorus || result.potassium) {
                    resultHtml += '<h4>üß™ NPK Estimates</h4>';
                    if (result.nitrogen) resultHtml += `<p><strong>Nitrogen:</strong> ${result.nitrogen.toFixed(2)}%</p>`;
                    if (result.phosphorus) resultHtml += `<p><strong>Phosphorus:</strong> ${result.phosphorus.toFixed(2)}%</p>`;
                    if (result.potassium) resultHtml += `<p><strong>Potassium:</strong> ${result.potassium.toFixed(2)}%</p>`;
                    if (result.npk_confidence) resultHtml += `<p><strong>Confidence:</strong> ${(result.npk_confidence * 100).toFixed(1)}%</p>`;
                }

                addTestSection('GEE Service', 'success', resultHtml);

                // Final success message
                addTestSection('üéâ INTEGRATION COMPLETE', 'success',
                    '<h3>‚úÖ GOOGLE EARTH ENGINE INTEGRATION SUCCESSFUL!</h3>' +
                    '<p>Your Plant Saathi app can now retrieve real satellite data from Google Earth Engine.</p>' +
                    '<p><strong>What this means:</strong></p>' +
                    '<ul>' +
                    '<li>‚úÖ Real Sentinel-2 satellite imagery</li>' +
                    '<li>‚úÖ Accurate vegetation indices</li>' +
                    '<li>‚úÖ Reliable NPK estimates</li>' +
                    '<li>‚úÖ Cloud cover information</li>' +
                    '<li>‚úÖ Fallback to simulation when needed</li>' +
                    '</ul>');

            } catch (error) {
                addTestSection('Test Execution', 'error',
                    `‚ùå Test execution failed: ${error.message}<br><br>
                    <strong>Stack trace:</strong><br>
                    <pre>${error.stack}</pre>`);
            } finally {
                button.disabled = false;
                button.textContent = 'Run GEE Integration Test';
            }
        }

        function addTestSection(title, status, content) {
            const resultsDiv = document.getElementById('test-results');
            const section = document.createElement('div');
            section.className = `test-section ${status}`;
            section.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            resultsDiv.appendChild(section);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Auto-run test if URL contains ?autorun
        if (window.location.search.includes('autorun')) {
            setTimeout(runGEETest, 1000);
        }
    </script>
</body>
</html>
